{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Meine Abwesenheiten" %} - {{ block.super }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">{% trans "Meine Abwesenheiten" %} {{ year }}</h1>
        <div class="btn-group">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#vacationModal">
                <i class="bi bi-calendar-plus"></i> {% trans "Urlaub" %}
            </button>
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#timeCompModal">
                <i class="bi bi-clock-history"></i> {% trans "Zeitausgleich" %}
            </button>
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#sickLeaveModal">
                <i class="bi bi-thermometer-half"></i> {% trans "Krankenstand" %}
            </button>
        </div>
    </div>

    <!-- Erste Zeile: Übersichten -->
    <div class="row mb-4">
        <!-- Urlaubsübersicht -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-queen-blue">
                    <h5 class="mb-0">{% trans "Urlaubsübersicht" %}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card border-0">
                    
                                <div class="card-body text-center">
                                    <h6>{% trans "Gesamtanspruch" %}</h6>
                                    {% widthratio vacation_remaining_hours vacation_total_available 100 as percent %}
                                    <h3>{{ vacation_total_available|floatformat:1 }}h</h3>
                                    <small class="text-muted">
                                        ({{ vacation_entitlement.total_hours|floatformat:1 }}h + {{ vacation_last_year_remaining|default:"0"|floatformat:1 }}h {% trans "Übertrag" %})
                                    </small>
                                </div>
                                <div class="progress mb-3" style="height: 25px;">
                                    {% widthratio vacation_remaining_minus_pending vacation_total_available 100 as percent %}
                                    {% widthratio vacation_pending_hours vacation_total_available 100 as pending_percent %}
                                    <!-- Available hours (minus pending) -->
                                    <div class="progress-bar 
                                        {% with percent_num=percent|add:"0" %}
                                            {% if percent_num >= 50 %}bg-pistachio
                                            {% elif percent_num >= 25 %}bg-yellow-orange
                                            {% else %}bg-red-salsa{% endif %}
                                        {% endwith %}"
                                        role="progressbar" 
                                        style="width: {{ percent }}%;" 
                                        aria-valuenow="{{ vacation_remaining_minus_pending }}" 
                                        aria-valuemin="0" 
                                        aria-valuemax="{{ vacation_total_available }}">
                                        {{ vacation_remaining_minus_pending|default:0|floatformat:1 }}h
                                    </div>
                                    <!-- Pending hours -->
                                    <div class="progress-bar-striped bg-yellow-orange" 
                                         role="progressbar" 
                                         style="width: {{ pending_percent }}%;"
                                         aria-valuenow="{{ vacation_pending_hours }}"
                                         aria-valuemin="0" 
                                         aria-valuemax="{{ vacation_total_available }}">
                                        {{ vacation_pending_hours|default:0|floatformat:1 }}h
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card border-0">
                                <div class="card-body text-center">
                                    <h6>{% trans "Genommen" %}</h6>
                                    <h3>{{ vacation_approved_hours|floatformat:1 }}h</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0">
                                <div class="card-body text-center">
                                    <h6>{% trans "Beantragt" %}</h6>
                                    <h3>{{ vacation_pending_hours|floatformat:1 }}h</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0">
                                <div class="card-body text-center">
                                    <h6>{% trans "Verbleibend" %}</h6>
                                    <h3>{{ vacation_remaining_hours|floatformat:1 }}h</h3>
                                </div>
                            </div>
                        </div>
                    </div>  
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card border-0">
                                <div class="card-body text-center">
                                    <button class="btn bg-queen-blue" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#vacationModal"
                                            data-remaining-hours="{{ vacation_remaining_hours }}">
                                        <i class="bi bi-plus-circle"></i> {% trans "Urlaub beantragen" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Zeitausgleich-Übersicht -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-queen-blue">
                    <h5 class="mb-0">{% trans "Zeitausgleich-Übersicht" %}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card border-0">
                                <div class="card-body text-center">
                                    <h6>{% trans "ZA-Konto" %}</h6>
                                    {% widthratio timecomp_remaining_hours timecomp_total_hours 100 as timecomp_percent %}
                                    <h3>{{ timecomp_total_hours|floatformat:1 }}h</h3>
                                    <small class="text-muted">
                                        {% trans "Verfügbare Überstunden für Zeitausgleich" %}
                                    </small>
                                </div>
                                <div class="progress mb-3" style="height: 25px;">
                                    <div class="progress-bar 
                                        {% with percent_num=timecomp_percent|add:"0" %}
                                            {% if percent_num >= 50 %}bg-pistachio
                                            {% elif percent_num >= 25 %}bg-yellow-orange
                                            {% else %}bg-red-salsa{% endif %}
                                        {% endwith %}"
                                        role="progressbar" 
                                        style="width: {{ timecomp_percent }}%;" 
                                        aria-valuenow="{{ timecomp_remaining_hours|default:0 }}" 
                                        aria-valuemin="0" 
                                        aria-valuemax="{{ timecomp_total_hours|default:0 }}">
                                        {{ timecomp_remaining_hours|default:0|floatformat:1 }}h
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card border-0">
                                <div class="card-body text-center">
                                    <h6>{% trans "Genommen" %}</h6>
                                    <h3>{{ timecomp_used_hours|floatformat:1 }}h</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0">
                                <div class="card-body text-center">
                                    <h6>{% trans "Beantragt" %}</h6>
                                    <h3>{{ timecomp_pending_hours|floatformat:1 }}h</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0">
                                <div class="card-body text-center">
                                    <h6>{% trans "Verbleibend" %}</h6>
                                    <h3>{{ timecomp_remaining_hours|floatformat:1 }}h</h3>
                                </div>
                            </div>
                        </div>
                    </div>  
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card border-0">
                                <div class="card-body text-center">
                                    <button class="btn bg-queen-blue" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#timeCompModal"
                                            data-remaining-hours="{{ timecomp_remaining_hours }}">
                                        <i class="bi bi-plus-circle"></i> {% trans "Zeitausgleich beantragen" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Zweite Zeile: Urlaub und Zeitausgleich -->
    <div class="row mb-4">
        <!-- Urlaub -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-brightness-high text-warning"></i> {% trans "Urlaub" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% for vacation in vacations %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <strong>{{ vacation.start_date|date:"d.m.Y" }} - {{ vacation.end_date|date:"d.m.Y" }}</strong>
                            <br>
                            <small class="text-muted">{{ vacation.hours|floatformat:1 }} {% trans "Stunden" %}</small>
                            {% if vacation.notes %}
                            <br>
                            <small class="text-muted">{{ vacation.notes }}</small>
                            {% endif %}
                        </div>
                        <div class="btn-group">
                            {% if vacation.status == 'REQUESTED' %}
                            <button type="button" 
                                    class="btn btn-sm bg-red-salsa rounded-circle"
                                    onclick="deleteAbsence('vacation', {{ vacation.id }})"
                                    title="{% trans 'Stornieren' %}">
                                <i class="bi bi-x-circle"></i>
                            </button>
                            {% endif %}
                            <span class="badge {% if vacation.status == 'APPROVED' %}bg-success{% elif vacation.status == 'REQUESTED' %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ vacation.get_status_display }}
                            </span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted mb-0">{% trans "Keine Urlaubsanträge" %}</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Zeitausgleich -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history text-info"></i> {% trans "Zeitausgleich" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% for tc in time_comps %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <strong>{{ tc.date|date:"d.m.Y" }}</strong>
                            <br>
                            <small class="text-muted">{{ tc.hours|floatformat:1 }} {% trans "Stunden" %}</small>
                            {% if tc.notes %}
                            <br>
                            <small class="text-muted">{{ tc.notes }}</small>
                            {% endif %}
                        </div>
                        <div class="btn-group">
                            {% if tc.status == 'REQUESTED' %}
                            <button type="button" 
                                    class="btn btn-sm bg-red-salsa rounded-circle"
                                    onclick="deleteAbsence('time_comp', {{ tc.id }})"
                                    title="{% trans 'Stornieren' %}">
                                <i class="bi bi-x-circle"></i>
                            </button>
                            {% endif %}
                            <span class="badge {% if tc.status == 'APPROVED' %}bg-success{% elif tc.status == 'REQUESTED' %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ tc.get_status_display }}
                            </span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted mb-0">{% trans "Keine Zeitausgleichsanträge" %}</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Dritte Zeile: Krankenstand -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-hospital text-danger"></i> {% trans "Krankenstand" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% for sl in sick_leaves %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <strong>{{ sl.start_date|date:"d.m.Y" }} - {{ sl.end_date|date:"d.m.Y" }}</strong>
                            {% if sl.notes %}
                            <br>
                            <small class="text-muted">{{ sl.notes }}</small>
                            {% endif %}
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge {% if sl.status == 'SUBMITTED' %}bg-success{% else %}bg-warning{% endif %}">
                                {{ sl.get_status_display }}
                            </span>
                            {% if sl.document %}
                                <a href="{{ sl.document.file.url }}" 
                                   class="btn btn-sm btn-info" 
                                   target="_blank">
                                    <i class="bi bi-file-earmark-text"></i> 
                                </a>
                            {% else %}
                                <button type="button" 
                                        class="btn btn-sm btn-primary upload-sick-note-btn" 
                                        data-sick-leave-id="{{ sl.id }}"
                                        data-employee-id="{{ request.user.id }}">
                                    <i class="bi bi-upload"></i> 
                                </button>
                            {% endif %}
                            
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted mb-0">{% trans "Keine Krankmeldungen" %}</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals am Ende des Contents -->
{% include "wfm/modals/vacation_modal.html" %}
{% include "wfm/modals/time_compensation_modal.html" %}
{% include "wfm/modals/sick_leave_modal.html" %}
{% include "wfm/modals/document_upload_modal.html" with users=users %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
function deleteAbsence(type, id) {
    if (confirm('{% trans "Möchten Sie diesen Antrag wirklich stornieren?" %}')) {
        fetch(`/api/absence/${type}/${id}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || '{% trans "Ein Fehler ist aufgetreten" %}');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "Ein Fehler ist aufgetreten" %}');
        });
    }
}

$(document).ready(function() {
    console.log('Document ready'); // Debug
    
    // Upload Button Click Handler
    $('.upload-sick-note-btn').on('click', function(e) {
        console.log('Upload button clicked'); // Debug
        e.preventDefault();
        
        const sickLeaveId = $(this).data('sick-leave-id');
        const employeeId = $(this).data('employee-id');
        const dateText = $(this).closest('.d-flex').find('strong').text();
        const startDate = dateText.split(' - ')[0];
        
        console.log('Data:', { // Debug
            sickLeaveId,
            employeeId,
            dateText,
            startDate
        });
        
        // Setze den Mitarbeiter und die Notiz im Upload-Modal
        $('#user').val(employeeId);
        $('#sick_leave_id').val(sickLeaveId);  // Setze die ID im versteckten Feld
        $('#display_name').val(`{{ request.user.get_full_name }} - Krankmeldung vom ${startDate}`);
        $('#notes').val('');  // Keine ID mehr in den Notes
        
        console.log('Form values:', { // Debug
            user: $('#user').val(),
            display_name: $('#display_name').val(),
            notes: $('#notes').val()
        });
        
        // Überschreibe das Form-Submit-Event
        $('#documentUploadForm').off('submit').on('submit', function(e) {
            console.log('Form submitted'); // Debug
            e.preventDefault();
            
            const formData = new FormData(this);
            
            $.ajax({
                url: $(this).attr('action'),
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    console.log('Upload success:', response); // Debug
                    // Schließe das Modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('documentUploadModal'));
                    modal.hide();
                    
                    // Lade die Seite neu
                    location.reload();
                },
                error: function(xhr) {
                    console.error('Upload error:', xhr); // Debug
                    alert('{% trans "Fehler beim Hochladen" %}');
                }
            });
        });
        
        // Öffne das Modal
        const modal = new bootstrap.Modal(document.getElementById('documentUploadModal'));
        modal.show();
    });
});
</script>
{% endblock %} 