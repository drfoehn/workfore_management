{% load i18n %}

<div class="modal fade" id="overtimeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-queen-blue">
                <h5 class="modal-title">{% trans "Überstunden zur Auszahlung" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-8">{% trans "Aktuelle Stundenbilanz" %}:</div>
                            <div class="col-4" id="currentBalance">0</div>
                        </div>
                        <div class="row">
                            <div class="col-8">{% trans "Zur Auszahlung markiert" %}:</div>
                            <div class="col-4" id="markedForPayment">0</div>
                        </div>
                        {% comment %} <div class="row">
                            <div class="col-8">{% trans "Verbleibende Stunden" %}:</div>
                            <div class="col-4" id="remainingHours">0</div>
                        </div> {% endcomment %}
                    </div>
                </div>

                <form id="overtimeForm" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="hoursForPayment" class="form-label">
                            {% trans "Stunden zur Auszahlung markieren" %}
                        </label>
                        <input type="number" 
                               class="form-control" 
                               id="hoursForPayment" 
                               name="hours_for_payment"
                               step="0.5" 
                               min="0"
                               required>
                        <div class="invalid-feedback">
                            {% trans "Bitte geben Sie eine gültige Stundenzahl ein" %}
                        </div>
                        <small class="form-text text-muted">
                            {% trans "Geben Sie die Anzahl der Stunden ein, die ausgezahlt werden sollen" %}
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "Schließen" %}
                </button>
                <button type="button" class="btn btn-primary" onclick="submitOvertimePayment()">
                    {% trans "Speichern" %}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const overtimeModal = document.getElementById('overtimeModal');
    if (overtimeModal) {
        overtimeModal.addEventListener('show.bs.modal', loadOvertimeData);
        
        // Input Validierung und Live-Update
        const hoursInput = document.getElementById('hoursForPayment');
        hoursInput.addEventListener('input', function() {
            updateRemainingHours();
        });
    }
});

// Neue Funktion zur Berechnung der verbleibenden Stunden
function updateRemainingHours() {
    const currentBalance = parseFloat(document.getElementById('currentBalance').textContent);
    const markedHours = parseFloat(document.getElementById('markedForPayment').textContent);
    const remainingHours = currentBalance - markedHours;
    
    document.getElementById('remainingHours').textContent = remainingHours.toFixed(1);
    
    // Validierung
    const input = document.getElementById('hoursForPayment');
    const inputValue = parseFloat(input.value) || 0;
    if (inputValue > currentBalance) {
        input.setCustomValidity('Nicht genügend Stunden verfügbar');
        document.getElementById('remainingHours').classList.add('text-danger');
    } else {
        input.setCustomValidity('');
        document.getElementById('remainingHours').classList.remove('text-danger');
    }
}

function loadOvertimeData() {
    fetch('{% url "wfm:api-overtime-overview" %}', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        
        
        const balance = parseFloat(data.balance);
        const markedHours = parseFloat(data.hours_for_payment);
        const remainingHours = balance - markedHours;
        
        

        // Aktualisiere alle Anzeigen
        document.getElementById('currentBalance').textContent = balance.toFixed(1);
        document.getElementById('markedForPayment').textContent = markedHours.toFixed(1);
        document.getElementById('remainingHours').textContent = remainingHours.toFixed(1);
        
        // Aktualisiere das Input-Feld
        const input = document.getElementById('hoursForPayment');
        if (input) {
            input.max = balance;
            input.value = markedHours;
            input.disabled = data.is_paid;
            
            
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{% trans "Fehler beim Laden der Überstunden" %}');
    });
}

function submitOvertimePayment() {
    const form = document.getElementById('overtimeForm');
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }
    
    const hours = parseFloat(document.getElementById('hoursForPayment').value);
    const currentBalance = parseFloat(document.getElementById('currentBalance').textContent);
    
    if (hours > currentBalance) {
        alert('{% trans "Nicht genügend Stunden verfügbar" %}');
        return;
    }
    
    fetch('{% url "wfm:api-overtime-overview" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            hours_for_payment: hours
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const balance = parseFloat(data.balance);
            const markedHours = parseFloat(data.hours_for_payment);
            const remainingHours = balance - markedHours;  // Berechne verbleibende Stunden
            
            document.getElementById('currentBalance').textContent = balance.toFixed(1);
            document.getElementById('markedForPayment').textContent = markedHours.toFixed(1);
            document.getElementById('remainingHours').textContent = remainingHours.toFixed(1);
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('overtimeModal'));
            modal.hide();
            
            alert('{% trans "Überstunden wurden erfolgreich zur Auszahlung markiert" %}');
        } else {
            alert(data.error || '{% trans "Ein Fehler ist aufgetreten" %}');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{% trans "Fehler beim Speichern" %}');
    });
}
</script>